# Author: Omar Abdeldayem
# Workflow: Animated Contribution Graph Generator
# Description: Creates and updates a contribution graph animation showing a snake consuming your commits.

name: Contribution Snake Generator

on:
  # Run every 6 hours
  schedule:
    - cron: "0 */6 * * *"
  # Manual trigger
  workflow_dispatch:

jobs:
  generate-snake:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for pushing to other branches

      # Step 2: Generate contribution snake GIF and SVG
      - name: Generate contribution snake
        uses: Platane/snk@master
        id: snake
        with:
          github_user_name: your-github-username
          gif_out_path: dist/contribution-snake.gif
          svg_out_path: dist/contribution-snake.svg

      # Step 3: Push GIF/SVG to output branch
      - name: Push snake animation to output branch
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: output
          force: true

      # Step 4: Update profile README to display the snake GIF
      - name: Update profile README with snake GIF
        run: |
          README="README.md"
          GIF_URL="https://github.com/${{ github.repository }}/raw/output/dist/contribution-snake.gif"

          # Make sure README exists
          if [ ! -f "$README" ]; then
            echo "# $GITHUB_REPOSITORY" > $README
          fi

          # Remove old snake GIF line if it exists
          sed -i '/!\[Contribution Snake\]/d' $README

          # Add the updated GIF at the bottom
          echo "" >> $README
          echo "![Contribution Snake]($GIF_URL)" >> $README

          # Commit and push the README update to main
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add $README
          git commit -m "Update contribution snake GIF in profile README" || echo "No changes to commit"
          git push origin main
